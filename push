#!/bin/bash
#
# Push a newly-built image with the given label to gcr.io and DockerHub.
#
# Usage:
#   ./push [--gpu] [LABEL]
#
# Description:
#   LABEL: Docker image label. Defaults to "testing".
#
# Options:
#   --gpu: Psuh the image with GPU support.
# 
set -e
set -x

SOURCE_IMAGE="kaggle/python-build"
TARGET_IMAGE="gcr.io/kaggle-images/python"

if [[ "$1" == "--gpu" ]]; then
    SOURCE_IMAGE="kaggle/python-gpu-build"
    TARGET_IMAGE="gcr.io/kaggle-private-byod/python"
    shift
fi

LABEL=${1:-testing}

docker tag $SOURCE_IMAGE:latest $TARGET_IMAGE:$LABEL
gcloud docker -- push $TARGET_IMAGE:$LABEL

# Only CPU images are made public at this time.
if [[ "$LABEL" == "latest" && SOURCE_IMAGE = "kaggle/python-build" ]]; then
  docker tag $SOURCE_IMAGE:latest kaggle/python:$LABEL
  docker push kaggle/python:$LABEL
fi
